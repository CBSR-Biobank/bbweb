@(cetForm: Form[controllers.study.CeventTypeFormObject],
        formType: FormType,
        studyId: String,
        studyName: String,
        specimenGroupMap : Seq[(String,String,String)])(
        implicit request: play.api.mvc.WrappedRequest[play.api.mvc.AnyContent])

@import helper._
@import controllers.study._

    @implicitFieldConstructor = @{ FieldConstructor(twitterBootstrapInput.f) }

    @formInfo = @{ formType match {
        case AddFormType() =>
            FormInfo(Messages("biobank.study.collection.event.type.add"),
                routes.CeventTypeController.addCeventTypeSubmit(studyId, studyName))
        case UpdateFormType() =>
            FormInfo(Messages("biobank.study.collection.event.type.update"),
                routes.CeventTypeController.updateCeventTypeSubmit(studyId, studyName))
    }}

@main(formInfo.title) {
    @breadcrumbs(Map(
        (Messages("biobank.study.plural") -> routes.StudyController.index),
        (studyName -> routes.StudyController.showStudy(studyId)),
        (formInfo.title -> null)
    ))
    <div class="page-header">
        <h2>@Messages("biobank.study.singular"): @studyName</h2>
        <h3>@formInfo.title</h3>
    </div>


    @if(cetForm.hasErrors) {
        <div class="alert">
            <p>@Messages("biobank.common.form.fix.errors")</p>
        </div>
    }

    <div class="clearfix">
    @form(formInfo.action, args = 'id -> "addform", 'class -> "form-horizontal") {

        @formType match {
            case AddFormType() => {
                <input type="hidden" name="collectionEventTypeId" value="dont-care">
                <input type="hidden" name="version" value="-1" >
            }
            case UpdateFormType() => {
                <input type="hidden" name="collectionEventTypeId"
                value="@cetForm("collectionEventTypeId").value" >
                <input type="hidden" name="version" value="@cetForm("version").value" >
            }
        }

        <input type="hidden" name="studyId" value="@studyId" >

        @formNameAndDescription(cetForm("name"), cetForm("description"))

        @checkbox(field = cetForm("recurring"),
            args = '_label -> Messages("biobank.study.collection.event.type.field.recurring"),
            '_help -> "")
            
        <div class="control-group sgSelectionGroup">
            <label class="control-label">
                @Messages("biobank.study.collection.event.field.specimen.groups")
            </label>
            <div class="controls">
                <a class="addSpecimenGroup btn success">
                    @Messages("biobank.study.collection.event.form.action.specimen.group.add")
                </a>
            </div>
        </div>

        @repeat(cetForm("specimenGroupData"), 
            min = cetForm("specimenGroupData").indexes.size) { sgGroupData =>
            @sgSelectionGroup(sgGroupData, specimenGroupMap)
        }

        @**
        * This hidden block will be used as template for Javascript copy code
        **@
        @sgSelectionGroup(cetForm("specimenGroupData[x]"), specimenGroupMap, 
            className = "sg_selection_template", style="display: none;")

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">@Messages("biobank.form.submit")</button>
        </div>
    }
    </div>

    <script type="text/javascript" charset="utf-8">
        $(function() {
        var sgTemplate = $('.sg_selection_template')

        var sgUnits={'': '@Messages("biobank.study.specimengroup.field.units")',
        @Html(specimenGroupMap.map(x => """'%s': '%s'""".format(x._1, x._3)).mkString(","))}

        var sgRenameElementAttr = function(element, id) {
            var namerepl = element.attr('name').replace(/specimenGroupData\[.+\]/g, "specimenGroupData[" + id + "]")
            element.attr('name', namerepl)
        }

        var sgRenameGroup = function(sg, id) {
            sgRenameElementAttr(sg.find('select'), id)
            sg.find('input').each(function() {
                sgRenameElementAttr($(this), id)
            })

            var select = sg.find('select')
            select.bind('change', function(event) {
                // updates the "units" on the amount field
                var addOn = $(this).parent().parent().parent().find('.add-on')
                addOn.text(sgUnits[$(this).val()])
            })
            var selectLabel = select.parent().parent().find('label')
            //var newText =  selectLabel.text().replace(/[0-9]+/g, (id + 1))
            //selectLabel.text(newText)
        }
        
        // update existing amount fields "units"
        $('.add-on').each(function(i,v) {
            var select = $(this).parent().parent().parent().parent().find('select')
            $(this).text(sgUnits[select.val()])
        })

        //
        // creates a new selection text entry field based on the hidden template. The
        // new input field has to be modified to contain the correct parameters
        //
        $(document).on('click', '.addSpecimenGroup', function() {
            var i = $('.sgselection').size()
            var newSg = sgTemplate.clone().removeClass('sg_selection_template').addClass('sgselection')
            sgRenameGroup(newSg, i)
            newSg.show()
            sgTemplate.before(newSg)
        })

        //
        // removes a selection text entry field based on the button pressed
        //
        $(document).on('click', '.removeSpecimenGroup', function() {
            var i = $('.sgselection').size()
            if (i > 0) {
                $(this).parent().parent().parent().remove()
                renumberSpecimenGroups()
            }
        })

        // -- renumber fields specimen groups
        //
        var renumberSpecimenGroups = function() {
            $('.sgselection').each(function(i) {
                sgRenameGroup($(this), i)
            })
        }

        })
    </script>
}
